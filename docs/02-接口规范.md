# 接口规范

> 本文档定义 RESTful API 接口设计规范，包括URL格式、端类型、HTTP方法、响应格式、错误码等。

---

## 1. URL 格式规范

### 1.1 标准格式

```
/{项目}/{端类型}/v{版本号}/{模块}/{资源}
```

| 组成部分 | 说明 | 示例 |
|----------|------|------|
| `{项目}` | 项目名称 | `toy`玩具项目 |
| `{端类型}` | 客户端类型 | `web`, `api`, `open`, `internal` |
| `v{版本号}` | API版本 | `v1`, `v2` |
| `{模块}` | 业务模块 | `user`, `order`, `product` |
| `{资源}` | 资源名称 | 可选，用于子资源 |

### 1.2 端类型定义

| 端类型 | 说明 | 使用场景 | 示例 |
|--------|------|----------|------|
| `web` | 管理后台 | PC端管理系统、运营后台 | `/toy/web/v1/user` |
| `api` | 移动端 | App、小程序、H5 | `/toy/api/v1/user/profile` |
| `open` | 开放接口 | 第三方对接、设备端、开放API | `/toy/open/v1/oauth/token` |
| `callback` | 回调接口 | 第三方回调、Webhook | `/toy/callback/v1/payment/notify` |
| `internal` | 内部接口 | 服务内部接口相互调用 | `/toy/internal/v1/device/command` |

### 1.3 URL 命名规则

| 规则 | 说明 | 正确示例 | 错误示例 |
|------|------|----------|----------|
| 小写字母 | URL全部小写 | `/toy/web/v1/user` | `/toy/Web/V1/User` |
| 连字符分隔 | 多单词用连字符 | `/toy/web/v1/user-address` | `/toy/web/v1/userAddress` |
| 名词资源 | 资源用名词 | `/toy/web/v1/order` | `/toy/web/v1/get-order` |
| 动作使用HTTP方法 | 动作由HTTP方法表达，URL不写create/update | `/toy/web/v1/order` | `/toy/web/v1/order/create` |
| 无尾斜杠 | URL末尾不加斜杠 | `/toy/web/v1/user` | `/toy/web/v1/user/` |

---

## 2. HTTP 方法规范

### 2.1 方法定义

| 方法 | 用途 | 幂等性 | 示例 |
|------|------|--------|------|
| GET | 查询资源 | 是 | 获取列表、详情 |
| POST | 创建资源 | 否 | 新增数据、提交表单 |
| PUT | 更新资源（全量/部分） | 是 | 修改数据 |
| DELETE | 删除资源 | 是 | 删除数据 |

### 2.2 标准 CRUD 接口

```
# 列表/分页查询
GET    /{project}/web/v1/{module}
GET    /{project}/web/v1/{module}?pageNo=1&pageSize=10

# 详情查询
GET    /{project}/web/v1/{module}/{id}

# 创建
POST   /{project}/web/v1/{module}

# 更新
PUT    /{project}/web/v1/{module}/{id}

# 删除
DELETE /{project}/web/v1/{module}/{id}

# 批量删除
POST   /{project}/web/v1/{module}/batch-delete

# 状态变更
PUT    /{project}/web/v1/{module}/{id}/status?enabled=1
```

### 2.3 接口示例（以玩具项目、用户模块为例）

```
# ========== Web 管理后台 ==========
GET    /toy/web/v1/user                   # 用户列表/分页（pageNo/pageSize可选）
GET    /toy/web/v1/user/{id}              # 用户详情
POST   /toy/web/v1/user                   # 创建用户
PUT    /toy/web/v1/user/{id}              # 更新用户
DELETE /toy/web/v1/user/{id}              # 删除用户
POST   /toy/web/v1/user/batch-delete      # 批量删除
PUT    /toy/web/v1/user/{id}/status?enabled=1  # 启用/禁用用户（enabled=1/0）
PUT    /toy/web/v1/user/{id}/reset-pwd    # 重置密码
GET    /toy/web/v1/user/export            # 导出用户

# ========== App 移动端 ==========
GET    /toy/api/v1/user/profile           # 获取个人信息
PUT    /toy/api/v1/user/profile           # 更新个人信息
PUT    /toy/api/v1/user/avatar            # 更新头像
PUT    /toy/api/v1/user/password          # 修改密码
PUT    /toy/api/v1/user/phone             # 绑定手机号

# ========== 认证接口 ==========
POST   /toy/web/v1/auth/login             # 管理后台登录
POST   /toy/web/v1/auth/logout            # 退出登录
GET    /toy/web/v1/auth/info              # 获取登录信息
POST   /toy/api/v1/auth/login/phone       # 手机号登录
POST   /toy/api/v1/auth/login/wechat      # 微信登录
POST   /toy/api/v1/auth/register          # 注册
POST   /toy/api/v1/auth/sms/send          # 发送验证码

# ========== 开放接口 ==========
POST   /toy/open/v1/oauth/token           # 获取访问令牌
POST   /toy/open/v1/oauth/refresh         # 刷新令牌
GET    /toy/open/v1/user/{id}             # 获取用户信息

# ========== 回调接口 ==========
POST   /toy/callback/v1/payment/notify    # 支付回调
POST   /toy/callback/v1/sms/status        # 短信状态回调

# ========== 内部接口 ==========
POST   /toy/internal/v1/device/command       # 下发指令
POST   /toy/internal/v1/device/auth          # 设备认证
```

---

## 3. 请求规范

### 3.1 请求头

| Header | 说明 | 示例 |
|--------|------|------|
| Content-Type | 内容类型 | `application/json` |
| Authorization | 认证令牌 | `Bearer {token}` |
| X-Request-Id | 请求追踪ID | `uuid` |
| X-Client-Version | 客户端版本 | `1.0.0` |
| X-Platform | 平台标识 | `ios`, `android`, `web` |

### 3.2 查询参数（GET请求）

```
# 分页参数
GET /toy/web/v1/user?pageNo=1&pageSize=10

# 筛选参数
GET /toy/web/v1/user?status=1&keyword=张三

# 排序参数
GET /toy/web/v1/user?sortField=createTime&sortOrder=desc

# 时间范围
GET /toy/web/v1/order?startTime=2024-01-01&endTime=2024-12-31
```

### 3.3 请求体（POST/PUT请求）

```json
// 创建请求
POST /toy/web/v1/user
{
    "username": "zhangsan",
    "phone": "13800138000",
    "email": "zhangsan@example.com",
    "status": 1
}

// 更新请求
PUT /toy/web/v1/user/123
{
    "username": "zhangsan_new",
    "phone": "13800138001"
}

// 批量操作
POST   /toy/web/v1/user/batch-delete
{
    "ids": [1, 2, 3, 4, 5]
}
```

---

## 4. 响应规范

### 4.1 统一响应格式

```json
{
    "code": 0,
    "message": "成功",
    "data": { ... },
    "timestamp": 1704067200000
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| code | int | 状态码，0表示成功 |
| message | string | 提示信息 |
| data | object/array | 业务数据 |
| timestamp | long | 响应时间戳（毫秒） |

### 4.2 成功响应示例

```json
// 无数据返回
{
    "code": 0,
    "message": "成功",
    "data": null,
    "timestamp": 1704067200000
}

// 单条数据
{
    "code": 0,
    "message": "成功",
    "data": {
        "id": 1,
        "username": "zhangsan",
        "phone": "138****8000",
        "status": 1,
        "createTime": "2024-01-01 12:00:00"
    },
    "timestamp": 1704067200000
}

// 列表数据
{
    "code": 0,
    "message": "成功",
    "data": [
        { "id": 1, "name": "项目A" },
        { "id": 2, "name": "项目B" }
    ],
    "timestamp": 1704067200000
}

// 分页数据
{
    "code": 0,
    "message": "成功",
    "data": {
        "records": [
            { "id": 1, "username": "zhangsan" },
            { "id": 2, "username": "lisi" }
        ],
        "total": 100,
        "pageNo": 1,
        "pageSize": 10,
        "pages": 10
    },
    "timestamp": 1704067200000
}
```

### 4.3 失败响应示例

```json
// 业务错误
{
    "code": 20001,
    "message": "用户不存在",
    "data": null,
    "timestamp": 1704067200000
}

// 参数校验错误
{
    "code": 90001,
    "message": "参数错误",
    "data": {
        "errors": [
            { "field": "phone", "message": "手机号格式不正确" },
            { "field": "email", "message": "邮箱不能为空" }
        ]
    },
    "timestamp": 1704067200000
}

// 系统错误
{
    "code": 99999,
    "message": "系统繁忙，请稍后重试",
    "data": null,
    "timestamp": 1704067200000
}
```

---

## 5. 错误码规范

### 5.1 错误码分段

| 范围 | 模块 | 说明 |
|------|------|------|
| 0 | 成功 | 请求成功 |
| 10000-19999 | 认证/权限 | 登录、Token、权限等 |
| 20000-29999 | 用户模块 | 用户相关错误 |
| 30000-39999 | 订单模块 | 订单相关错误 |
| 40000-49999 | 商品模块 | 商品相关错误 |
| 50000-59999 | 支付模块 | 支付相关错误 |
| 60000-69999 | 文件模块 | 文件上传等错误 |
| 90000-99999 | 系统/通用 | 参数、资源、系统级错误 |

### 5.2 认证错误码（10000-19999）

| 错误码   | 说明 | 场景 |
|-------|------|------|
| 10001 | 未登录 | Token为空或无效 |
| 10002 | Token已过期 | 需要重新登录 |
| 10003 | 无权限 | 没有操作权限 |
| 10004 | 账号被禁用 | 账号状态异常 |
| 10005 | Token无效 | Token校验失败 |
| 10006 | 验证码错误 | 验证码校验失败 |
| 10007 | 验证码已过期 | 验证码超时 |
### 5.3 通用错误码（90000-99999）

| 错误码   | 说明 | 场景 |
|-------|------|------|
| 90001 | 参数错误 | 参数校验失败 |
| 90002 | 参数缺失 | 必填参数为空 |
| 90003 | 参数格式错误 | 格式不符合要求 |
| 90004 | 资源不存在 | 数据不存在 |
| 90005 | 资源已存在 | 数据重复 |
| 90006 | 操作频繁 | 触发限流 |
| 90007 | 操作失败 | 操作未成功 |
| 90008 | 数据不存在 | 查询结果为空 |
| 90009 | 请求方法不允许 | 方法不支持 |
| 99999 | 系统错误 | 系统级错误 |

### 5.4 业务错误码示例

```java
// 用户模块 (20000-29999)
USER_NOT_FOUND(20001, "用户不存在"),
USER_ALREADY_EXISTS(20002, "用户已存在"),
USER_DISABLED(20003, "用户已禁用"),
PASSWORD_ERROR(20004, "密码错误"),
PHONE_ALREADY_BOUND(20005, "手机号已被绑定"),
OLD_PASSWORD_ERROR(20006, "原密码错误"),

// 订单模块 (30000-39999)
ORDER_NOT_FOUND(30001, "订单不存在"),
ORDER_STATUS_ERROR(30002, "订单状态异常"),
ORDER_ALREADY_PAID(30003, "订单已支付"),
ORDER_ALREADY_CANCELLED(30004, "订单已取消"),
ORDER_CANNOT_CANCEL(30005, "订单无法取消"),

// 商品模块 (40000-49999)
PRODUCT_NOT_FOUND(40001, "商品不存在"),
PRODUCT_OFF_SHELF(40002, "商品已下架"),
STOCK_NOT_ENOUGH(40003, "库存不足"),

// 支付模块 (50000-59999)
PAYMENT_FAILED(50001, "支付失败"),
PAYMENT_TIMEOUT(50002, "支付超时"),
REFUND_FAILED(50003, "退款失败"),
```

---

## 6. 版本管理

### 6.1 版本号规则

- 使用 `v1`, `v2`, `v3` 格式
- 大版本升级时递增（不兼容变更）
- 小版本变更不改变URL

### 6.2 版本兼容

```
# 当前版本
/{project}/web/v1/user

# 新版本（不兼容变更）
/{project}/web/v2/user

# 旧版本保留一段时间后废弃
```

### 6.3 废弃接口标记

```java
/**
 * @deprecated 请使用 /{project}/web/v2/user
 */
@Deprecated
@GetMapping("/{project}/web/v1/user")
public R<List<UserResponse>> listV1() {
}
```

---

## 7. 接口文档规范

### 7.1 Swagger 注解

```java
@Tag(name = "用户管理")
@RestController
@RequestMapping("/{project}/web/v1/user")
public class UserController {

    @Operation(summary = "用户列表/分页", description = "支持按状态、关键词筛选")
    @GetMapping
    public R<IPage<UserResponse>> page(
            @Parameter(description = "页码") @RequestParam(defaultValue = "1") Integer pageNo,
            @Parameter(description = "每页数量") @RequestParam(defaultValue = "10") Integer pageSize,
            @Parameter(description = "状态") @RequestParam(required = false) Integer status,
            @Parameter(description = "关键词") @RequestParam(required = false) String keyword) {
    }

    @Operation(summary = "创建用户")
    @PostMapping
    public R<Long> create(@RequestBody @Validated UserCreateRequest request) {
    }
}
```

### 7.2 DTO 注解

```java
@Data
@Schema(description = "用户创建请求")
public class UserCreateRequest {

    @Schema(description = "用户名", requiredMode = Schema.RequiredMode.REQUIRED, example = "zhangsan")
    @NotBlank(message = "用户名不能为空")
    private String username;

    @Schema(description = "手机号", requiredMode = Schema.RequiredMode.REQUIRED, example = "13800138000")
    @NotBlank(message = "手机号不能为空")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;

    @Schema(description = "状态", example = "1")
    private Integer status;
}
```
