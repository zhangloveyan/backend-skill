# 开发规范

> 本文档定义数据库、日志、注释、安全、Git提交等开发规范。

---

## 1. 数据库规范

### 1.1 表命名规范

| 规则 | 说明 | 示例 |
|------|------|------|
| 小写字母 | 全部使用小写 | `user`, `order` |
| 下划线分隔 | 多单词用下划线 | `user_address`, `order_item` |
| 单数形式 | 表名使用单数 | `user`（推荐），`users`（不推荐） |
| 业务前缀 | 可选，区分模块 | `sys_user`, `biz_order` |
| 禁止保留字 | 避免使用数据库保留字 | `order` → `orders` 或 `biz_order` |

### 1.2 字段命名规范

| 规则 | 说明 | 示例 |
|------|------|------|
| 小写下划线 | snake_case 格式 | `user_id`, `create_time` |
| 主键 | 统一使用 `id` | `id BIGINT` |
| 外键 | `{关联表}_id` | `user_id`, `order_id` |
| 创建人 | create_by | `VARCHAR(64)` |
| 更新人 | update_by | `VARCHAR(64)`           |
| 创建时间 | `create_time` | `DATETIME` |
| 更新时间 | `update_time` | `DATETIME` |
| 逻辑删除 | `del_flag` | `TINYINT(1)` |
| 状态字段 | `status` | `TINYINT` |
| 布尔字段 | `is_xxx` 或直接名词 | `is_enabled`, `enabled` |

### 1.3 通用字段

每张业务表应包含以下通用字段：

```sql
-- 主键（自增）
id BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',

-- 操作人、时间字段
create_by VARCHAR(64) NOT NULL COMMENT '创建人',
update_by VARCHAR(64) COMMENT '更新人',
create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
update_time DATETIME COMMENT '更新时间',

-- 逻辑删除
del_flag TINYINT(1) NOT NULL DEFAULT 0 COMMENT '删除标记 (0-未删除, 1-已删除)',

-- 主键约束
PRIMARY KEY (id)
```

### 1.4 索引规范

| 规则 | 说明 | 示例 |
|------|------|------|
| 命名格式 | `idx_{表名}_{字段名}` | `idx_user_phone` |
| 唯一索引 | `uk_{表名}_{字段名}` | `uk_user_email` |
| 联合索引 | 高选择性字段在前 | `idx_order_user_status` |

### 1.5 字段类型选择

| 数据类型 | MySQL 类型 | Java 类型 | 说明 |
|----------|------------|-----------|------|
| 主键/ID | BIGINT | Long | 自增           |
| 短字符串 | VARCHAR(n) | String | n ≤ 255 |
| 长字符串 | TEXT | String | 大文本 |
| 整数 | INT | Integer | 常规整数 |
| 小整数 | TINYINT | Integer/Boolean | 状态、标记 |
| 小数 | DECIMAL(m,n) | BigDecimal | 金额等精确计算 |
| 日期时间 | DATETIME | Date | 时间戳 |
| 日期 | DATE | Date | 仅日期 |
| JSON | JSON | String | JSON数据 |

### 1.6 建表模板

```sql
-- {表描述}
CREATE TABLE `{table_name}` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',

    -- 业务字段
    `name` VARCHAR(100) NOT NULL COMMENT '名称',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态 (1-启用, 0-禁用)',

    -- 操作人、时间字段
    `create_by` VARCHAR(64) NOT NULL COMMENT '创建人',
    `update_by` VARCHAR(64) COMMENT '更新人',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` DATETIME COMMENT '更新时间',
    
    `del_flag` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '删除标记',

    PRIMARY KEY (`id`),
    INDEX `idx_{table_name}_status` (`status`),
    INDEX `idx_{table_name}_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='{表描述}';
```

---

## 2. 日志规范

### 2.1 日志级别

| 级别 | 使用场景 | 示例 |
|------|----------|------|
| ERROR | 系统错误、异常捕获、影响业务的错误 | 数据库连接失败、第三方接口异常 |
| WARN | 潜在问题、业务警告、可恢复的异常 | 参数校验失败、重试操作 |
| INFO | 关键业务流程、重要操作、状态变更 | 用户登录、订单创建、支付成功 |
| DEBUG | 调试信息、详细流程、开发阶段使用 | 方法入参、中间变量 |

### 2.2 日志格式

```java
// ✓ 正确：使用占位符 + 类名.方法名
log.info("[UserService.login] 用户登录成功, userId={}, ip={}", userId, ip);
log.error("[OrderService.create] 订单创建失败, orderId={}", orderId, e);

// ✗ 错误：字符串拼接
log.info("用户登录成功, userId=" + userId);  // 性能差

// ✗ 错误：缺少方法标识
log.info("用户登录成功, userId={}", userId);  // 难以追踪
```

### 2.3 日志内容规范

```java
// 方法入口
log.info("[UserService.create] 开始创建用户, param={}", param);

// 关键步骤
log.info("[UserService.create] 校验通过, 开始保存数据");

// 方法出口
log.info("[UserService.create] 用户创建成功, userId={}", userId);

// 异常记录（必须包含异常对象）
log.error("[UserService.create] 用户创建失败, param={}", param, e);
```

### 2.4 日志格式说明

```
[类名.方法名] 操作描述, 参数1={}, 参数2={}

示例：
[UserService.login] 用户登录成功, userId=123, ip=192.168.1.1
[OrderService.create] 订单创建失败, orderId=456
[PaymentService.callback] 支付回调处理, orderNo=789, status=SUCCESS
```

### 2.5 禁止事项

```java
// ✗ 禁止打印敏感信息
log.info("用户密码={}", password);      // 密码
log.info("手机号={}", phone);           // 完整手机号
log.info("身份证={}", idCard);          // 身份证号
log.info("银行卡={}", bankCard);        // 银行卡号

// ✓ 正确：脱敏处理
log.info("手机号={}", DesensitizeUtils.phone(phone));  // 138****8888

// ✗ 禁止在循环中打印日志
for (User user : userList) {
    log.info("处理用户: {}", user.getId());  // 可能产生大量日志
}

// ✓ 正确：批量记录
log.info("批量处理用户, count={}, ids={}", userList.size(), userIds);
```

### 2.6 日志配置建议

```yaml
# application.yml
logging:
  level:
    root: INFO
    com.{company}.{project}: DEBUG  # 项目包开启DEBUG
    org.springframework: WARN
    org.mybatis: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
```

---

## 3. 注释规范

### 3.1 类注释

```java
/**
 * 用户服务实现类
 * <p>
 * 处理用户相关的业务逻辑，包括注册、登录、信息管理等
 * </p>
 *
 * @author {author}
 * @since {date}
 */
@Service
public class UserServiceImpl implements UserService {
}
```

### 3.2 方法注释

```java
/**
 * 根据ID获取用户信息
 *
 * @param id 用户ID
 * @return 用户信息，不存在返回null
 */
public User getById(Long id) {
}

/**
 * 创建用户
 *
 * @param request 创建请求
 * @return 用户ID
 * @throws BusinessException 当手机号已存在时抛出
 */
public Long create(UserCreateRequest request) {
}
```

### 3.3 字段注释

```java
/**
 * 用户状态
 * @see UserStatusEnum
 */
private Integer status;

/** 创建时间 */
private LocalDateTime createTime;
```

### 3.4 行内注释

```java
// 检查用户是否存在
User user = userMapper.selectById(id);
if (user == null) {
    throw new BusinessException(ErrorCode.USER_NOT_FOUND);
}

// 校验密码（使用BCrypt）
if (!passwordEncoder.matches(password, user.getPassword())) {
    throw new BusinessException(ErrorCode.PASSWORD_ERROR);
}
```

### 3.5 TODO 注释

```java
// TODO: 待实现用户头像上传功能
// FIXME: 修复并发情况下的库存扣减问题
// XXX: 此处逻辑需要优化，当前为临时方案
```

---

## 4. 安全规范

### 4.1 密码处理

```java
// ✓ 正确：使用BCrypt加密存储
@Autowired
private PasswordEncoder passwordEncoder;

// 加密
String encodedPassword = passwordEncoder.encode(rawPassword);

// 验证
boolean matches = passwordEncoder.matches(rawPassword, encodedPassword);

// ✗ 错误
String password = DigestUtils.md5Hex(rawPassword);  // MD5不安全
String password = rawPassword;  // 明文存储
```

### 4.2 敏感信息处理

```java
// 日志脱敏
log.info("手机号={}", DesensitizeUtils.phone(phone));      // 138****8888
log.info("身份证={}", DesensitizeUtils.idCard(idCard));    // 110***********1234
log.info("邮箱={}", DesensitizeUtils.email(email));        // t***@example.com

// 响应脱敏（使用注解）
@Desensitize(type = DesensitizeType.PHONE)
private String phone;

// 配置文件加密
spring:
  datasource:
    password: ENC(加密后的密码)
```

### 4.3 参数校验

```java
// 使用 JSR-303 注解
public class UserCreateRequest {

    @NotBlank(message = "用户名不能为空")
    @Size(min = 2, max = 20, message = "用户名长度2-20个字符")
    private String username;

    @NotBlank(message = "密码不能为空")
    @Size(min = 6, max = 20, message = "密码长度6-20个字符")
    private String password;

    @NotBlank(message = "手机号不能为空")
    @Pattern(regexp = "^1[3-9]\\d{9}$", message = "手机号格式不正确")
    private String phone;

    @Email(message = "邮箱格式不正确")
    private String email;
}

// Controller 中使用 @Validated
@PostMapping("/create")
public R<Long> create(@RequestBody @Validated UserCreateRequest request) {
}
```

### 4.4 SQL注入防护

```java
// ✓ 正确：使用参数化查询
@Select("SELECT * FROM user WHERE id = #{id}")
User selectById(@Param("id") Long id);

// ✓ 正确：MyBatis-Plus LambdaQuery
lambdaQuery().eq(User::getId, id).one();

// ✗ 错误：字符串拼接
@Select("SELECT * FROM user WHERE id = " + id)  // SQL注入风险
String sql = "SELECT * FROM user WHERE name = '" + name + "'";  // 危险！
```

### 4.5 XSS防护

```java
// 输入过滤
String safeContent = HtmlUtils.htmlEscape(userInput);

// 使用注解
@XssFilter
private String content;
```

### 4.6 接口安全

```java
// 认证：JWT Token
@GetMapping("/profile")
@RequireLogin  // 需要登录
public R<UserResponse> getProfile() {
}

// 授权：角色/权限控制
@DeleteMapping("/{id}")
@RequirePermission("user:delete")  // 需要权限
public R<Void> delete(@PathVariable Long id) {
}

// 限流：防止接口滥用
@RateLimit(limit = 10, period = 60)  // 60秒内最多10次
@PostMapping("/send-code")
public R<Void> sendCode() {
}
```

---

## 5. Git 提交规范

### 5.1 提交信息格式

```
<type>: <subject>

<body>

<footer>
```

### 5.2 Type 类型

| 类型 | 说明 | 示例 |
|------|------|------|
| feat | 新功能 | `feat: 添加用户注册功能` |
| fix | 修复bug | `fix: 修复登录验证码失效问题` |
| docs | 文档变更 | `docs: 更新API文档` |
| style | 代码格式（不影响功能） | `style: 格式化代码` |
| refactor | 重构（不是新功能也不是修复） | `refactor: 重构用户服务` |
| perf | 性能优化 | `perf: 优化查询性能` |
| test | 测试相关 | `test: 添加用户服务单元测试` |
| chore | 构建/工具变更 | `chore: 升级依赖版本` |
| revert | 回滚 | `revert: 回滚xxx提交` |

### 5.3 Subject 规范

- 使用中文或英文，保持一致
- 不超过50个字符
- 不以句号结尾
- 使用祈使句（动词开头）

### 5.4 提交示例

```bash
# 简单提交
git commit -m "feat: 添加用户注册功能"

# 带详细说明
git commit -m "feat: 添加用户注册功能

- 实现手机号注册
- 添加验证码校验
- 集成短信发送服务

Closes #123"

# 修复bug
git commit -m "fix: 修复订单金额计算错误

原因：折扣计算时精度丢失
方案：使用BigDecimal进行计算

Fixes #456"
```

### 5.5 分支规范

| 分支 | 说明 | 命名 |
|------|------|------|
| master/main | 生产分支 | `master` |
| develop | 开发分支 | `develop` |
| feature | 功能分支 | `feature/user-register` |
| bugfix | 修复分支 | `bugfix/login-error` |
| hotfix | 紧急修复 | `hotfix/payment-bug` |
| release | 发布分支 | `release/v1.0.0` |

### 5.6 工作流程

```bash
# 1. 从develop创建功能分支
git checkout develop
git pull origin develop
git checkout -b feature/user-register

# 2. 开发并提交
git add .
git commit -m "feat: 添加用户注册功能"

# 3. 推送并创建PR
git push origin feature/user-register
# 在Git平台创建Pull Request

# 4. 代码审查通过后合并到develop
# 5. 删除功能分支
git branch -d feature/user-register
```

---

## 6. 代码风格

### 6.1 基本规则

| 规则 | 说明 |
|------|------|
| 缩进 | 4个空格，禁止Tab |
| 行宽 | 不超过120字符 |
| 空行 | 方法之间空一行，逻辑块之间空一行 |
| 大括号 | 左括号不换行，右括号独占一行 |

### 6.2 导入规范

```java
// 导入顺序
import java.util.*;                    // 1. java
import javax.servlet.*;                // 2. javax
import org.springframework.*;          // 3. 第三方库
import com.{company}.{project}.*;      // 4. 项目内部

// 禁止
import java.util.*;  // ✗ 禁止星号导入
```

### 6.3 方法规范

```java
// 方法长度：建议不超过50行
// 参数个数：建议不超过5个，超过使用对象封装

// ✗ 参数过多
public void createOrder(Long userId, Long productId, Integer quantity,
    BigDecimal price, String address, String phone, String remark) {
}

// ✓ 使用对象封装
public void createOrder(OrderCreateRequest request) {
}
```
