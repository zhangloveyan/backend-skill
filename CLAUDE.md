# 项目开发规范

> 角色：务实的后端开发，直接沟通，按规范执行，不讨好用户，不过度设计。

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2025-01-15 | 初始版本 |
| v2.0 | 2025-01-16 | 重构文档结构，精简流程，合并 Skill |
| v2.1 | 2026-01-16 | 完善开发流程，增加 review/test 必做环节 |

---

## 1. 开发流程

```
需求输入 → 需求分析 ⇄ 用户确认 → 技术方案 ⇄ 用户确认 → 任务拆分
    ↓
代码生成(/gen) → 业务逻辑开发 → 代码审查(/review) → 生成测试(/gen-test) → 运行测试
    ↓
用户确认 → Git提交
```

### 1.1 流程阶段

| 阶段 | Skill | 说明 | 确认点 |
|------|-------|------|--------|
| 需求分析 | `/analyze-req` | 澄清需求、明确边界、输出需求文档 | 用户确认需求 |
| 技术方案 | `/analyze-design` | 数据库、接口、代码结构设计 | 用户确认方案 |
| 任务拆分 | `/task` | 拆分为可执行的任务列表 | - |
| 代码生成 | `/gen` | 生成 SQL、Entity、CRUD、枚举等 | - |
| 业务开发 | - | 实现具体业务逻辑 | 阶段性确认 |
| 测试 | `/gen-test` | 生成单元测试、集成测试 | - |
| 审查 | `/review` | 代码自检、提交前检查 | - |

### 1.2 开发顺序

单个功能的开发顺序：
1. SQL 建表 → 2. Entity 实体 → 3. Mapper → 4. Controller/DTO → 5. Service 接口 → 6. Service 实现（业务逻辑） → 7. Git 提交

### 1.3 Git 提交时机

- 按功能模块提交，不是每个文件
- 一个完整功能点开发完成后提交
- 提交信息格式：`<type>: <subject>`

### 1.4 开发完成后必做

代码开发完成后，必须按顺序执行：
1. `/review` - 代码自检，修复发现的问题
2. `/gen-test` - 生成测试代码
3. 运行测试 - 确保测试通过
4. 用户确认后再提交

**注意**：以上步骤应主动执行，不需要用户提醒。

### 1.5 技术方案变更同步

技术方案设计时如发现需求遗漏或变更，需同步更新需求文档。

---

## 2. 强制规则

### 2.1 流程规则（必须做）

| 规则 | 说明 |
|------|------|
| 先问再做 | 需求不清楚必须先澄清，禁止假设 |
| 分阶段确认 | 需求确认 → 方案确认 → 开发，不可跳过 |
| 逐个开发 | 按任务列表顺序，一个完成再下一个 |
| 阶段性确认 | 开发过程中遇到疑问及时确认 |

### 2.2 安全红线（禁止做）

- 禁止明文存储密码（必须 BCrypt）
- 禁止日志打印敏感信息（密码、手机号、身份证）
- 禁止 SQL 拼接（必须 `#{}`）
- 禁止信任前端传入的用户ID（必须从 Token 获取）

### 2.3 性能红线

- 禁止循环内查询数据库（N+1 问题）
- 禁止深度分页（offset > 10000）
- 禁止不带条件的全表查询
- 禁止单次查询超过 1000 条不分批

### 2.4 代码红线

- 禁止 `System.out.println`
- 禁止空 catch
- 禁止硬编码魔法值
- 禁止方法超过 50 行、类超过 500 行

---

## 3. 项目规范

### 3.1 技术栈

| 类别 | 技术 | 版本 |
|------|------|------|
| JDK | OpenJDK | 17+ |
| 框架 | Spring Boot | 3.x |
| ORM | MyBatis-Plus | 3.5.x |
| 数据库 | MySQL | 8.0+ |
| 缓存 | Redis | 7.0+ |
| API文档 | Knife4j | 4.x |

### 3.2 模块结构

```
{project}/
├── {project}-common/    # 通用模块
├── {project}-core/      # 业务核心
├── {project}-admin/     # 管理后台 (Web端)
└── {project}-api/       # 对外接口 (App端)
```

### 3.3 包结构

```
com.{company}.{project}.{module}/
├── controller/          # 控制器
├── service/impl/        # 服务层
├── mapper/              # 数据访问
├── entity/              # 实体类
├── model/request/       # 请求DTO
├── model/response/      # 响应DTO
└── enums/               # 枚举类
```

### 3.4 命名规范

| 类型 | 规则 | 示例 |
|------|------|------|
| 类名 | 大驼峰 | `UserService` |
| 方法/变量 | 小驼峰 | `getUserById` |
| 常量 | 大写下划线 | `MAX_PAGE_SIZE` |
| 表名 | 小写下划线，单数 | `user`, `order_item` |
| 字段名 | 小写下划线 | `user_id`, `create_time` |

### 3.5 类命名约定

| 类型 | 格式 |
|------|------|
| 实体类 | `{Entity}` |
| Mapper | `{Entity}Mapper` |
| Service | `{Entity}Service` / `{Entity}ServiceImpl` |
| Controller | `{Entity}Controller` |
| 请求DTO | `{Entity}CreateRequest` / `{Entity}UpdateRequest` |
| 响应DTO | `{Entity}Response` |

### 3.6 接口规范

**URL 格式**：`/{项目}/{端类型}/v{版本}/{模块}/{资源}`

端类型：`web`(管理后台) | `api`(App) | `open`(开放)

**RESTful**：

| 操作 | 方法 | 路径 |
|------|------|------|
| 列表 | GET | `/{module}` |
| 详情 | GET | `/{module}/{id}` |
| 创建 | POST | `/{module}` |
| 更新 | PUT | `/{module}/{id}` |
| 删除 | DELETE | `/{module}/{id}` |

**响应格式**：
```json
{"code": 0, "message": "成功", "data": {}}
```

### 3.7 通用字段

每张业务表必须包含：
```
id, del_flag, create_by, create_time, update_by, update_time
```

### 3.8 错误码分段

| 范围 | 模块 |
|------|------|
| 0 | 成功 |
| 10000-10999 | 认证授权 |
| 11000-11999 | 权限控制 |
| 20000+ | 业务模块（按 +1000 递增） |
| 90000-99999 | 系统错误 |

---

## 4. Skill 索引

### 4.1 流程类

| Skill | 场景 | 说明 |
|-------|------|------|
| `/analyze-req` | 需求分析 | 澄清需求、明确边界、生成需求文档 |
| `/analyze-design` | 技术方案 | 数据库、接口、代码结构设计 |
| `/task` | 任务管理 | 创建、更新、查看任务 |
| `/review` | 代码审查 | 提交前自检 |

### 4.2 生成类

| Skill | 场景 | 说明 |
|-------|------|------|
| `/gen` | 代码生成 | 统一入口：SQL、CRUD、API、枚举 |
| `/gen-test` | 测试生成 | 单元测试、集成测试 |

### 4.3 辅助类

| Skill | 场景 | 说明 |
|-------|------|------|
| `/fix` | 修复Bug | 快速定位和修复 |
| `/change` | 需求变更 | 开发中需求调整 |
| `/resume` | 恢复开发 | 中断后继续 |
| `/refactor` | 重构 | 代码优化 |

### 4.4 参考类

| Skill | 场景 | 说明 |
|-------|------|------|
| `/common` | 公共类 | R、ErrorCode、异常类等 |
| `/deploy` | 部署配置 | Docker、Nginx 配置 |

### 4.5 调用顺序

**新模块开发**：
```
/analyze-req → /analyze-design → /task → /gen → 业务开发 → /gen-test → /review
```

**新增接口**：
```
/analyze-req(简化) → /analyze-design → /gen → /review
```

**修复Bug**：
```
/fix → /gen-test(补测试) → /review
```

---

## 5. 详细规范索引

以下规范在对应 Skill 文件中有详细说明：

| 规范 | 位置 |
|------|------|
| 需求分析流程 | `/analyze-req` |
| 技术方案模板 | `/analyze-design` |
| 代码生成模板 | `/gen` |
| 事务规范 | `/common` |
| 缓存规范 | `/common` |
| 并发控制 | `/common` |
| 异常处理 | `/common` |
| 日志规范 | `/common` |
| 测试规范 | `/gen-test` |
| 审查清单 | `/review` |

---

## 6. 文档管理

### 6.1 文档目录结构

```
docs/
├── req/           # 需求分析文档
├── design/        # 技术方案文档
├── task/          # 任务文档
└── sql/           # SQL 脚本
```

### 6.2 文档命名规范

**格式**：`{模块}_v{版本}.md`

**示例**：
- 需求文档：`docs/req/feedback_v1.md`
- 技术方案：`docs/design/feedback_v1.md`
- 任务文档：`docs/task/feedback_v1.md`
- SQL 脚本：`docs/sql/feedback.sql`

### 6.3 版本规则

| 场景 | 版本处理 |
|------|---------|
| 首次创建 | v1 |
| 需求变更 | 版本号 +1（v1 → v2） |
| 小修改 | 原地更新，不改版本 |

### 6.4 保存时机

| 阶段 | 保存动作 |
|------|---------|
| 需求确认后 | 保存到 `docs/req/{模块}_v{版本}.md` |
| 方案确认后 | 保存到 `docs/design/{模块}_v{版本}.md` |
| 任务拆分后 | 保存到 `docs/task/{模块}_v{版本}.md` |
